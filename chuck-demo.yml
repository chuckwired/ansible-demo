---
# Example Ansible Playbook to deploy a simple HTML5 application on AWS.
#
# Documentation:
#  - EC2: http://docs.ansible.com/ansible/ec2_module.
#  - ELB: http://docs.ansible.com/ansible/ec2_elb_lb_module.html
#  - EC2_ELB: http://docs.ansible.com/ansible/ec2_elb_module.html
#  - Aurthorized Keys: http://docs.ansible.com/ansible/authorized_key_module.html
#  - add_hosts: http://docs.ansible.com/ansible/add_host_module.html
#
# Application: https://github.com/pixelsign/html5-device-mockups

- hosts: localhost

  tasks: 
    - include: roles/stack/stack_creator.yml
      vars:
        nginx_instance_name: "chuck-demo-nginx"
        app_instance_name: "chuck-demo-app"
        elb_instance_name: "chuck-demo-elb"
        deployment_region: "eu-west-1"

    # Add the nginx EC2 address
    - include: roles/common/ec2_address.yml
      vars:
        instance_name: chuck-demo-nginx
        ssh_name: chuck-demo
        ssh_location: /Users/charlesrice/.ssh/

    # Add the App EC2 address - will export temporary EC2 addresses below {instance_name}.server
    - include: roles/common/ec2_address.yml
      vars:
        instance_name: chuck-demo-app
        ssh_name: chuck-demo
        ssh_location: /Users/charlesrice/.ssh/

    - name: Add SSH key for configuration connections
      authorized_key: user=charlesrice key="{{ lookup('file', '/Users/charlesrice/.ssh/id_rsa.pub') }}"

# "Setup the nginx EC2 instance
- hosts: chuck-demo-nginx.server
  remote_user: root

# TODO: Convert to a full role
  tasks:
    - include: roles/nginx/nginx.yml
      vars:
        elb_instance_name: "chuck-demo-elb"
        deployment_region: "eu-west-1"

# Setup the application EC2 instance
- hosts: chuck-demo-app.server
  remote_user: root

  tasks:
    - name: APP | Install Apache Web server
      yum: 
        name: httpd 
        state: present
    - name: APP | Run the web service
      service:
        name: httpd
        state: started
    - name: APP | Download an application
      git: 
        repo=https://github.com/pixelsign/html5-device-mockups.git
        dest=/var/www/html


